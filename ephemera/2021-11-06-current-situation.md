# 2021年10月現在のソースコード構成

2021年10月現在（というか2021年11月6日現在）における cerke_online フロントエンドが、いったいどうなっているのかを解説する。

## 特筆すべき命名規約
* `async` 関数は一つの例外もなく関数名が `send` か `animate` かで始まるようになっている。サーバーにものを送るのが主目的である関数に `send`、アニメーションをユーザーに表示するのを主目的とする関数に `animate` を付けていると期待したいが、そんなのをちゃんと守れているかは自信がない。
* 関数名が `create` で始まる関数は、画像の DOM を作る関数であり、必ず HTMLImageElement か SVGSVGElement を返す。

## フロントエンドを構成するHTMLファイル（ `public/main.html` 以外）
* `public/blog.html`: 更新履歴を載せるためだけにある静的サイト。

* `public/entrance.html`: 入口。実は基本的にはデザインを凝っただけのリンク集にすぎない。ただし、ステージング環境で入るとその旨が表示されるようになっているし、 `entrance.html?lang=x-faikleone` にすると日本語部分がリパライン語にすり替わるようになっているので、それをするためだけの 20 行ぐらいの生 JavaScript が書いてある。

* `public/pending_random.html`: entrance.html で「だれかと」を選んだときに飛ぶ先。`src/random_pending.ts` にロジックがある。
    * バックエンドの `/random/entry` に空オブジェクトの JSON を POST することでマッチングの予約がされる。
    * ステージング環境から送ると送信先が `/random/entry/staging` にすり替わるようになっており、これによりデバッグ目的で走らせているのか、それとも普通に人々が遊んでいるのかを切り分けることができる。
    * そのあとは `/random/poll` へとポーリングすることで、マッチングが発生したかどうかを調べ続ける。こいつにもステージング版の `/random/poll/staging` がある。
    * 対戦をキャンセルしたくなったときには、キャンセルボタンを押すことで entrance.html に戻る。このキャンセルボタンの正体はただのリンクであり、ページから離脱することによって `/random/cancel` にキャンセルの意思表示が送られるという仕組みになっている。こいつにも `/random/cancel/staging` がある。
    * 別タブに切り替えるなどした際にも、一度自動的にキャンセルを送るようにしている。これは「ページを閉じた」「ページを閉じようとしてる」というイベントは捕捉できる保証がないとMDNに書いてあったから。フォーカスが戻ってきたら対戦の再出願が行われる。
    * え、この `UNLOAD_TRIGGERED_BY_USER` って変数なに！？一度も書き込まれている様子が見えないけど。
    * マッチングに成功すると「アクセストークン・自分が先手かどうか・自分にとってIA列は画面下側であるかどうか」が返ってきて、それらを sessionStorage に書き込んで main.html に遷移することで試合が開始される。

* `public/pending_vs_cpu.html`: entrance で「CPUと」を選んだときに飛ぶ先。 `src/vs_cpu_pending.ts` にロジックがある。
    * バックエンドの `/vs_cpu/entry` に空オブジェクトの JSON を POST することでマッチングの予約がされる。
    * ステージング環境から送ると送信先が `/vs_cpu/entry/staging` にすり替わるようになっており、これによりデバッグ目的で走らせているのか、それとも普通に人々が遊んでいるのかを切り分けることができる。
    * bot は常に準備ができているので、ポーリングなどをする必要はなく、サーバーからすぐに返ってきた「アクセストークン・自分が先手かどうか・自分にとってIA列は画面下側であるかどうか」をsessionStorage に書き込んで main.html に遷移すれば、試合が開始される。
    * なお、キャンセル機構も省いてある。というのも、対人戦の場合は人が虚無とマッチしてもらっては困るが、対bot戦に関してはbotが虚無とマッチされたところで別に困らないからである。DDoS されると困る？そんな心配をするのはまだ早いよ。というか Heroku 側の謎のかしこさによって勝手になんとかなったりしてないのかな（知らん）

## `public/main.html`
`public/main.html` は対戦が起きる本体ページであり、マジでどうしようもなくなった巨大な混沌である。一応動いているが、どこにヤバが潜んでいるか分かったもんじゃない。

### 依存関係

![](https://raw.githubusercontent.com/jurliyuuri/cerke_online_alpha/master/ephemera/2021-11-06-cerke_online-dependency_cleaned.svg)

**うわぁ。**

なお、`src/main.ts` に至っては **2074行あり**、`src/opponent_move.ts` も **808行ある**。どうしてこんなになるまで放っておいたんだ。

* 魑魅魍魎のごった煮が入っている。読みたくない。

* バックエンドになにが送られるか、という観点で整理してこのファイル（というか、プログラム全体）が担当していることを述べると、
    1. 指した手の送信
        * 手を入力するまでの多段階的な UI を実現するために、生 DOM をいじって、生のイベントハンドラ付き画像を配置して、それがクリックされると遷移する巨大爆発ステートマシンを実現する。今はこれの解説はしない。
        * 手を入力するとそれがサーバーに送られる。バックエンドの `/slow` に POST される。
        * この `/slow` という名前は、もともとローカルでテストしていた際に、ネットワークを超えることによる遅延を再現するためにバックエンド側で `await new Promise(r => setTimeout(r, time));` を入れるということをしていたときの名残である。**じゃあ名前を直せよ**。
        * この `/slow` に物を送りつける関数の名を `sendStuff` というが、この関数を呼び出すやつが `sendNormalMessage` と `sendInfAfterStep` と `sendAfterHalfAcceptance` の三種類ある。
        * なぜかというと、踏越え後に無限移動をする際には、手を指している最中にバックエンドから乱数を受け取らなければならないという制約があるからである。
        * したがって、「踏越え後に無限移動」がないものについては `sendNormalMessage` を送ればいいが、「踏越え後に無限移動」がある場合は `sendInfAfterStep` を送り、サーバーから踏越え判定（踏越え後に無限移動できる距離の上限）を受け取る。これは一手の半分が受理された状態であるので、勝手に HalfAcceptance と呼んでいる。その HalfAccept した結果をユーザーに表示した上で、新たな制約を見たユーザーに意志決定をさせて、 `sendAfterHalfAcceptance` を送る。
    
    2. 役が成立したときに、再行（シーズン継続、レート倍加）するか、それとも終季（シーズン終了、点数獲得）するかの判断を送信
        * `/whethertymok` に、再行したかどうかの boolean を JSON で送る（【再行】のパイグ音は ty mok1 である）。
    
    3. 相手が手を指したかどうかの確認
        * これはバックエンドの `/mainpoll` に空オブジェクトを送りつけることで実現される。相手が手を指した場合、それを表示する必要があるが、それは `src/opponent_move.ts` に切り出されていたはずである。
    
    4. 相手が踏越え判定後の追加意志決定をしたかどうかの確認
        * これはバックエンドの `/infpoll` に空オブジェクトを送りつけることで実現される。相手が追加意志決定をした場合、それを表示する必要があるが、これも `src/opponent_move.ts` に切り出されていたはずである。
    
    5. 相手が役を作ったあとに、再行したか、終季したか、それともまだ決めてないかを確認
        * これはバックエンドの `/whethertymokpoll` に空オブジェクトを送りつけることで実現される。

といった感じ**だという気がしている**。

さて、残りのファイルについては、比較的機能ごとに分かれていて難易度が爆発していないことが期待される。

### `src/create_html_element.ts` (207行)
画像の DOM を作り、適切なスタイルを適用して、できたHTMLImageElement か SVGSVGElement を返す関数がたくさんおいてある。

### `src/dictionary.ts` (69行)
多言語対応用の文字列辞書。実はまだ日本語にしか対応していない。main.html 側にも言語切り替え機能は付いていない。

### `src/draw_erase_animate.ts` (378行)
主に `draw` や `erase` や `animate` という名前で始まる関数を格納しており、名前の通り DOM を変化させる工程を担当することが期待される。

### `src/env.ts` (10行)
送信先 URL が書いてあるだけ。これにより、バックエンドをローカルにしたり Heroku にしたりが容易にできる。

### `src/game_state.ts` (215行)
`GAME_STATE` という名のグローバル変数を定義している。
* sessionStorage に必要な物が入っていないと、この変数の初期値設定時にコケるわけだが、その際には entrance.html に強制的にお戻り頂くようにしてある。
* `is_my_turn` にはセッターが入っていて、セットするとアイコンの濃さなどが変わるようになっていく。このままいくと神クラス待ったなしだぞ、気をつけねば。 

### `src/html_top_left.ts` (35行)
画像とかの top とか left に指定すべき値を取ってくるためのお助け関数

### `src/kiar_ark.ts` (41行)
kiar_ark ってなんやねんと思う人もいるであろう。これは【日書】のパイグ音であり、棋譜のことである。
* 実は棋譜のフォーマットには[仕様（笑）](https://github.com/jurliyuuri/ckka#readme)がある。多分この仕様を守ったやつが排出されている気がするが、なんと自信はない。
* `KIAR_ARK` を `Proxy` として定義していて、書き込むとその内容がいい感じにテキスト化されてテキストボックスに出る。

### `src/main_entry.ts` (62行)
コードが関数の外にベタ書きされており、読み込まれた際に最初に走る。 **BGMや効果音のトグルを管理するコードが大半を占めてしまっている**。

### `src/piece_to_path.ts` (74行)
駒の画像パスを取ってくるだけの純粋関数。めちゃめちゃ簡単なただの条件分岐である。

### `src/score_display.ts` (151行)
役ができるごとに現在成立している役の一覧を描画し、ゲーム終了時には点数収支を表示する。
* 役は最大で11個成立することがあり、そういうときでも描画領域から溢れないように詰めて処理するための手作業マジックナンバーが書かれてたりする。

### `src/to_digits.ts` (108行)
数の描画には若干クセがあり、たとえば `-6848` は【下六八百四八】(ut2 net2 nom2 kit1 ap1 nom2) と表現する。そのためにこのファイルを切り出してある。
